<html>
<head>
	<link rel="stylesheet" href="https://hosted-sip.civic.com/css/civic-modal.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://hosted-sip.civic.com/js/civic.sip.min.js"></script>
	<script>
	  var civicSip = new civic.sip({ appId: 'ryzLV3KOz' });
	</script>
</head>
<body>

	<button id="signupButton" class="civic-button-a medium" type="button">
		<span>Log in with Civic</span>
	</button>

	<button id="demoButton" type="button">
		<span>Generate Demo Code</span>
	</button>

<div>
	<img style="display:none" src="nope.jpg" id="qr"/>
</div>

	<script>

		var ELECTION_ADDRESS = "0x520a7cba19762b8beee8462a7fb6b0dbce464d8d";
  $(document).ready(function () {

  var button = document.querySelector('#signupButton');
  button.addEventListener('click', function () {
    civicSip.signup({ style: 'popup', scopeRequest: civicSip.ScopeRequests.BASIC_SIGNUP });
  });

  var demoButton = document.querySelector("#demoButton");
  demoButton.addEventListener('click', function () {
	  sendGenerateAuthCode();
  });

  // Listen for data
  civicSip.on('auth-code-received', function (event) {
    // encoded JWT Token is sent to the server
    var jwtToken = event.response;

    // Your function to pass JWT token to your server
      sendCivicAuthCode(jwtToken);
  });

  civicSip.on('user-cancelled', function (event) {
    /*
        event:
        {
          event: "scoperequest:user-cancelled"
        }
    */
   });

  civicSip.on('read', function (event) {
    /*
        event:
        {
          event: "scoperequest:read"
        }
    */
  });

   // Error events.
   civicSip.on('civic-sip-error', function (error) {
      // handle error display if necessary.
      console.log('   Error type = ' + error.type);
      console.log('   Error message = ' + error.message);
   });

   var sendCivicAuthCode = function (token) {
      $.ajax({
            url: 'https://us-central1-netvote1.cloudfunctions.net/vote/qr/civic',
            type: 'post',
            data: {
                address: ELECTION_ADDRESS
            },
            headers: {
                Authorization: 'Bearer '+token
            },
            dataType: 'text',
            success: function (data) {
                $("#qr").attr("src", "data:image/png;base64," + data).show();
            }
      });
   };

  var sendGenerateAuthCode = function () {
	  $.ajax({
		  url: 'https://us-central1-netvote1.cloudfunctions.net/vote/qr/generated/'+ELECTION_ADDRESS,
		  type: 'GET',
		  dataType: 'text',
		  success: function (data) {
			  $("#qr").attr("src", "data:image/png;base64," + data).show();
		  }
	  });
  };
 });
	</script>
</body>

</html>